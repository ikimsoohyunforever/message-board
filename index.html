<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ฮ่องเต้และขันที</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; }
        .message { background: #f5f5f5; padding: 15px; margin: 10px 0; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; }
        .message-meta { color: #666; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>ฮ่องเต้และขันที</h1>
    <div id="status">状态: 获取用户信息...</div>
    
    <input type="text" id="name" placeholder="Name">
    <textarea id="content" placeholder="ข้อความ" rows="3"></textarea>
    
    <button onclick="loadMessages()">รีเฟรช</button>
    <button onclick="submitMessage()">ส่ง</button>
    
    <div id="messages"></div>

    <script>
        // 配置
        const CONFIG = {
            account: 'messageboard2025',
            table: 'messages',
            sas: '?sv=2024-11-04&ss=t&srt=co&sp=rwdlacu&se=2026-02-12T01:08:00Z&st=2025-12-04T16:53:00Z&spr=https&sig=O6rDzpyGQV1o9nh4OfFpZZVczqeihnFwYxGYnDd4Hp4%3D'
        };
        
        const BASE_URL = `https://${CONFIG.account}.table.core.windows.net/${CONFIG.table}`;
        const FULL_URL = `${BASE_URL}${CONFIG.sas}`;
        
        // 访问者信息（带多备用方案）
        let visitorInfo = {
            ip: '未知',
            location: '未知',
            userAgent: navigator.userAgent.substring(0, 100),
            platform: getPlatformInfo()
        };

        // 获取平台信息（更精确）
        function getPlatformInfo() {
            const ua = navigator.userAgent;
            let platform = navigator.platform;
            
            if (ua.includes('Windows')) platform = 'Windows';
            else if (ua.includes('Mac')) platform = 'Mac';
            else if (ua.includes('Linux')) platform = 'Linux';
            else if (ua.includes('Android')) platform = 'Android';
            else if (ua.includes('iOS') || ua.includes('iPhone')) platform = 'iOS';
            
            return platform || '未知系统';
        }

        // 获取IP（多个备用API）
        async function fetchVisitorInfo() {
            const ipApis = [
                'https://ipinfo.io/json',
                'https://api64.ipify.org?format=json',
                'https://api.ipify.org?format=json',
                'https://ipapi.co/json/'
            ];
            
            // 尝试所有API直到成功
            for (let i = 0; i < ipApis.length; i++) {
                try {
                    const response = await fetch(ipApis[i], { timeout: 3000 });
                    if (response.ok) {
                        const data = await response.json();
                        visitorInfo.ip = data.ip || data.query || '未知';
                        break;
                    }
                } catch (e) {
                    console.log(`API ${i+1} 失败`);
                }
            }
            
            // 如果所有API都失败，尝试WebRTC检测（仅作备选）
            if (visitorInfo.ip === '未知') {
                try {
                    const rtc = new RTCPeerConnection({iceServers: []});
                    rtc.createDataChannel('');
                    rtc.createOffer().then(offer => rtc.setLocalDescription(offer));
                    rtc.onicecandidate = event => {
                        if (event.candidate) {
                            const candidate = event.candidate.candidate;
                            const ipMatch = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                            if (ipMatch) visitorInfo.ip = ipMatch[0];
                            rtc.close();
                        }
                    };
                    setTimeout(() => rtc.close(), 1000);
                } catch (e) {}
            }
            
            // 获取地理位置
            if (visitorInfo.ip !== '未知') {
                await fetchLocation(visitorInfo.ip);
            }
            
            document.getElementById('status').textContent = `状态: 就绪 (IP: ${visitorInfo.ip})`;
            console.log('用户信息:', visitorInfo);
        }

        // 获取地理位置
        async function fetchLocation(ip) {
            try {
                const response = await fetch(`https://ipapi.co/${ip}/json/`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.country_name) {
                        const location = [];
                        if (data.city) location.push(data.city);
                        if (data.region) location.push(data.region);
                        if (data.country_name) location.push(data.country_name);
                        visitorInfo.location = location.join(', ') || '未知';
                    }
                }
            } catch (e) {
                try {
                    // 备用API
                    const response = await fetch(`http://ip-api.com/json/${ip}?lang=zh-CN`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            const location = [];
                            if (data.city) location.push(data.city);
                            if (data.regionName) location.push(data.regionName);
                            if (data.country) location.push(data.country);
                            visitorInfo.location = location.join(', ') || '未知';
                        }
                    }
                } catch (e2) {
                    visitorInfo.location = '位置服务异常';
                }
            }
        }

        // 加载留言
        async function loadMessages() {
            try {
                const response = await fetch(`${FULL_URL}&$filter=PartitionKey eq 'messages'`, {
                    headers: { 'Accept': 'application/json;odata=nometadata' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayMessages(data.value || []);
                }
            } catch (e) {
                console.error('加载失败:', e);
            }
        }

        // 删除留言
        async function deleteMessage(partitionKey, rowKey) {
            if (!confirm('确定删除？')) return;
            
            try {
                const deleteUrl = `${BASE_URL}(PartitionKey='${encodeURIComponent(partitionKey)}',RowKey='${encodeURIComponent(rowKey)}')${CONFIG.sas}`;
                await fetch(deleteUrl, { method: 'DELETE', headers: { 'If-Match': '*' } });
                loadMessages();
            } catch (e) {
                alert('删除失败');
            }
        }

        // 提交留言
        async function submitMessage() {
            const name = document.getElementById('name').value.trim();
            const content = document.getElementById('content').value.trim();
            
            if (!content) {
                alert('请输入内容');
                return;
            }
            
            try {
                const entity = {
                    PartitionKey: 'messages',
                    RowKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: name || '匿名用户',
                    message: content,
                    timestamp: new Date().toISOString(),
                    userIp: visitorInfo.ip,
                    userLocation: visitorInfo.location,
                    userAgent: visitorInfo.userAgent,
                    userPlatform: visitorInfo.platform
                };
                
                await fetch(FULL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json;odata=nometadata',
                        'Prefer': 'return-no-content'
                    },
                    body: JSON.stringify(entity)
                });
                
                document.getElementById('name').value = '';
                document.getElementById('content').value = '';
                loadMessages();
            } catch (e) {
                alert('保存失败');
            }
        }

        // 显示留言
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            
            if (!messages.length) {
                container.innerHTML = '<div class="message">还没有留言</div>';
                return;
            }
            
            messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = messages.map(msg => `
                <div class="message">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>${escapeHtml(msg.name)}</strong>
                        <button class="delete-btn" onclick="deleteMessage('${escapeHtml(msg.PartitionKey)}', '${escapeHtml(msg.RowKey)}')">
                            Delete
                        </button>
                    </div>
                    <div>${escapeHtml(msg.message)}</div>
                    <div class="message-meta">
                        ${formatTime(msg.timestamp)}<br>
                        ${msg.userIp ? `IP: ${escapeHtml(msg.userIp)}` : 'IP: 无记录'} | 
                        ${msg.userLocation ? `位置: ${escapeHtml(msg.userLocation)}` : '位置: 无记录'} | 
                        ${msg.userPlatform ? `系统: ${escapeHtml(msg.userPlatform)}` : '系统: 无记录'}
                    </div>
                </div>
            `).join('');
        }

        // 辅助函数
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(isoString) {
            try {
                return new Date(isoString).toLocaleString('zh-CN');
            } catch {
                return isoString;
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置快捷键
            document.getElementById('content').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') submitMessage();
            });
            
            // 并行加载
            Promise.all([fetchVisitorInfo(), loadMessages()]);
        });
    </script>
</body>
</html>
