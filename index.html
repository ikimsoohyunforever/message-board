<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Azureäº‘ç«¯ç•™è¨€æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .header { background: linear-gradient(90deg, #0078d4, #00bcf2); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .status { background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 20px; display: inline-block; margin-top: 10px; }
        .form-section { padding: 30px; }
        input, textarea { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px; }
        textarea { min-height: 120px; resize: vertical; }
        .buttons { display: flex; gap: 10px; margin: 20px 0; }
        button { flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #0078d4; color: white; }
        .btn-primary:hover { background: #106ebe; transform: translateY(-2px); }
        .btn-refresh { background: #6c757d; color: white; }
        .btn-refresh:hover { background: #5a6268; transform: translateY(-2px); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; transform: translateY(-2px); }
        .messages-section { padding: 30px; max-height: 500px; overflow-y: auto; background: #f8f9fa; }
        .message { background: white; padding: 20px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 4px solid #28a745; }
        .msg-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .msg-name { font-weight: bold; color: #0078d4; font-size: 1.1rem; }
        .msg-time { color: #666; font-size: 0.9rem; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loading i { font-size: 48px; margin-bottom: 20px; color: #0078d4; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #c3e6cb; }
        .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 10px; margin: 10px 0; border: 1px solid #bee5eb; }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2rem; }
            .form-section, .messages-section { padding: 20px; }
            .buttons { flex-direction: column; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cloud"></i> Azureäº‘ç«¯ç•™è¨€æ¿</h1>
            <div class="status" id="status">
                <i class="fas fa-sync fa-spin"></i> æ­£åœ¨è¿æ¥Azure...
            </div>
        </div>
        
        <div class="form-section">
            <div id="message-container">
                <div class="info" id="info-message">
                    <i class="fas fa-info-circle"></i> æ­£åœ¨åˆå§‹åŒ–äº‘ç«¯è¿æ¥...
                </div>
            </div>
            
            <input type="text" id="name" placeholder="ä½ çš„åå­—ï¼ˆå¯é€‰ï¼‰" maxlength="20">
            <textarea id="message" placeholder="è¾“å…¥ç•™è¨€å†…å®¹... (Ctrl+Enterå¿«é€Ÿæäº¤)" maxlength="500"></textarea>
            
            <div class="buttons">
                <button class="btn-primary" id="submit-btn">
                    <i class="fas fa-paper-plane"></i> å‘å¸ƒåˆ°äº‘ç«¯
                </button>
                <button class="btn-refresh" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°ç•™è¨€
                </button>
                <button class="btn-success" id="reconnect-btn">
                    <i class="fas fa-plug"></i> é‡æ–°è¿æ¥
                </button>
            </div>
        </div>
        
        <div class="messages-section" id="messages-container">
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç•™è¨€...</h3>
                <p>è¯·ç¨å€™</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Azureé…ç½®
        // ============================================
        const AZURE_CONFIG = {
            accountName: 'messageboard2025',
            tableName: 'messages',
            sasToken: '?sv=2024-11-04&ss=t&srt=co&sp=rwdl&se=2026-02-12T23:59:29Z&st=2025-12-02T15:44:29Z&spr=https&sig=1KAtGlI7tHgxyzXpqMKfn9G7EHBzsszqMxhaMKTfCbw%3D'
        };
        
        const BASE_URL = `https://${AZURE_CONFIG.accountName}.table.core.windows.net/${AZURE_CONFIG.tableName}`;
        const FULL_URL = `${BASE_URL}${AZURE_CONFIG.sasToken}`;
        
        // ä»£ç†åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        const PROXIES = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://thingproxy.freeboard.io/fetch/'
        ];
        
        let currentProxy = null;
        let isConnected = false;
        
        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Azureç•™è¨€æ¿åˆå§‹åŒ–');
            console.log('è¡¨URL:', BASE_URL);
            
            setupEventListeners();
            initConnection();
        });
        
        // ============================================
        // è¿æ¥ç®¡ç†
        // ============================================
        async function initConnection() {
            showMessage('info', 'æ­£åœ¨åˆå§‹åŒ–äº‘ç«¯è¿æ¥...');
            updateStatus('æ­£åœ¨è¿æ¥Azure...');
            
            // æµ‹è¯•è¿æ¥å¹¶é€‰æ‹©æœ€ä½³ä»£ç†
            await findBestProxy();
            
            if (isConnected) {
                showMessage('success', 'âœ… Azureäº‘ç«¯è¿æ¥æˆåŠŸï¼ç•™è¨€å°†æ°¸ä¹…ä¿å­˜åœ¨Azureäº‘ç«¯ã€‚');
                loadMessages();
            } else {
                showMessage('error', 'âŒ æ— æ³•è¿æ¥Azureï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚');
            }
        }
        
        async function findBestProxy() {
            showMessage('info', 'æ­£åœ¨æµ‹è¯•ç½‘ç»œè¿æ¥...');
            
            // æµ‹è¯•æ¯ä¸ªä»£ç†
            for (let proxy of PROXIES) {
                try {
                    updateStatus(`æµ‹è¯•ä»£ç†: ${proxy.substring(0, 30)}...`);
                    
                    const testUrl = `${proxy}${encodeURIComponent(FULL_URL + '&$top=1')}`;
                    const response = await fetch(testUrl, { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const text = await response.text();
                        if (text.includes('<feed') || text.includes('{"value"')) {
                            currentProxy = proxy;
                            isConnected = true;
                            
                            console.log(`âœ… ä½¿ç”¨ä»£ç†: ${proxy}`);
                            updateStatus('âœ… Azureäº‘ç«¯å·²è¿æ¥');
                            
                            return true;
                        }
                    }
                } catch (error) {
                    console.log(`ä»£ç† ${proxy.substring(0, 30)}... å¤±è´¥: ${error.message}`);
                }
            }
            
            // æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥
            isConnected = false;
            updateStatus('âŒ è¿æ¥å¤±è´¥');
            return false;
        }
        
        // ============================================
        // Azureæ“ä½œå‡½æ•°
        // ============================================
        async function loadMessages() {
            if (!isConnected) {
                showMessage('error', 'æœªè¿æ¥åˆ°Azureäº‘ç«¯');
                return;
            }
            
            showLoading(true);
            
            try {
                const queryUrl = `${currentProxy}${encodeURIComponent(FULL_URL + '&$filter=PartitionKey eq \'messageBoard\'&$orderby=RowKey desc&$top=100')}`;
                
                const response = await fetch(queryUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const text = await response.text();
                let messages = [];
                
                if (text.includes('<feed')) {
                    // è§£æXMLå“åº”
                    messages = parseXmlMessages(text);
                } else if (text.includes('{"value"')) {
                    // è§£æJSONå“åº”
                    const data = JSON.parse(text);
                    messages = data.value || [];
                }
                
                displayMessages(messages);
                showMessage('success', `âœ… å·²åŠ è½½ ${messages.length} æ¡äº‘ç«¯ç•™è¨€`);
                
            } catch (error) {
                console.error('åŠ è½½ç•™è¨€å¤±è´¥:', error);
                showMessage('error', `åŠ è½½å¤±è´¥: ${error.message}`);
                showError('æ— æ³•ä»äº‘ç«¯åŠ è½½ç•™è¨€ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            } finally {
                showLoading(false);
            }
        }
        
        async function submitMessage() {
            if (!isConnected) {
                showMessage('error', 'è¯·å…ˆè¿æ¥åˆ°Azureäº‘ç«¯');
                return;
            }
            
            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!message) {
                showMessage('error', 'è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }
            
            if (message.length > 500) {
                showMessage('error', 'ç•™è¨€ä¸èƒ½è¶…è¿‡500å­—');
                return;
            }
            
            // åˆ›å»ºAzureè¡¨å®ä½“
            const entity = {
                PartitionKey: 'messageBoard',
                RowKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                name: name || 'åŒ¿åç”¨æˆ·',
                message: message,
                timestamp: new Date().toISOString(),
                ip: await getClientIP(),
                userAgent: navigator.userAgent.substring(0, 100)
            };
            
            showMessage('info', 'æ­£åœ¨ä¿å­˜åˆ°Azureäº‘ç«¯...');
            
            try {
                const response = await fetch(`${currentProxy}${encodeURIComponent(FULL_URL)}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(entity)
                });
                
                if (response.ok || response.status === 204) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('name').value = '';
                    document.getElementById('message').value = '';
                    
                    // é‡æ–°åŠ è½½ç•™è¨€
                    await loadMessages();
                    
                    showMessage('success', 'âœ… ç•™è¨€å·²æˆåŠŸä¿å­˜åˆ°Azureäº‘ç«¯ï¼');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showMessage('error', `ä¿å­˜å¤±è´¥: ${error.message}`);
            }
        }
        
        // ============================================
        // è§£æå‡½æ•°
        // ============================================
        function parseXmlMessages(xmlText) {
            const messages = [];
            
            try {
                // ç®€å•è§£æXMLï¼ˆå­—ç¬¦ä¸²å¤„ç†ï¼‰
                const entries = xmlText.split('<entry>');
                
                for (let i = 1; i < entries.length; i++) {
                    const entry = entries[i].split('</entry>')[0];
                    
                    // æå–å­—æ®µ
                    const nameMatch = entry.match(/<d:name[^>]*>([^<]*)<\/d:name>/);
                    const messageMatch = entry.match(/<d:message[^>]*>([^<]*)<\/d:message>/);
                    const timeMatch = entry.match(/<d:timestamp[^>]*>([^<]*)<\/d:timestamp>/);
                    
                    if (nameMatch && messageMatch) {
                        messages.push({
                            name: decodeHtml(nameMatch[1]),
                            message: decodeHtml(messageMatch[1]),
                            timestamp: timeMatch ? timeMatch[1] : new Date().toISOString(),
                            RowKey: entry.match(/<d:RowKey[^>]*>([^<]*)<\/d:RowKey>/) ? decodeHtml(entry.match(/<d:RowKey[^>]*>([^<]*)<\/d:RowKey>/)[1]) : ''
                        });
                    }
                }
            } catch (error) {
                console.error('XMLè§£æé”™è¯¯:', error);
            }
            
            return messages;
        }
        
        // ============================================
        // æ˜¾ç¤ºå‡½æ•°
        // ============================================
        function displayMessages(messages) {
            const container = document.getElementById('messages-container');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-comment-slash"></i>
                        <h3>è¿˜æ²¡æœ‰ç•™è¨€</h3>
                        <p>æˆä¸ºç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="message">
                    <div class="msg-header">
                        <div class="msg-name">
                            <i class="fas fa-user"></i> ${escapeHtml(msg.name)}
                        </div>
                        <div class="msg-time">
                            ${formatTime(msg.timestamp)}
                        </div>
                    </div>
                    <div style="margin: 10px 0; line-height: 1.6;">
                        ${escapeHtml(msg.message).replace(/\n/g, '<br>')}
                    </div>
                    <div style="font-size: 12px; color: #28a745;">
                        <i class="fas fa-cloud"></i> Azureäº‘ç«¯å­˜å‚¨
                        <span style="float: right; color: #666;">
                            ${msg.RowKey ? 'ID: ' + msg.RowKey.substring(0, 8) + '...' : ''}
                        </span>
                    </div>
                </div>
            `).join('');
        }
        
        function showLoading(show) {
            const container = document.getElementById('messages-container');
            if (show) {
                container.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <h3>æ­£åœ¨ä»äº‘ç«¯åŠ è½½ç•™è¨€...</h3>
                        <p>è¯·ç¨å€™</p>
                    </div>
                `;
            }
        }
        
        function showError(message) {
            const container = document.getElementById('messages-container');
            container.innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>åŠ è½½å¤±è´¥</h3>
                    <p>${message}</p>
                    <button onclick="loadMessages()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-redo"></i> é‡è¯•
                    </button>
                </div>
            `;
        }
        
        function showMessage(type, text) {
            const container = document.getElementById('message-container');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            const icon = type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            
            container.innerHTML = `
                <div class="${className}">
                    <i class="fas ${icon}"></i> ${text}
                </div>
            `;
            
            // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    if (container.innerHTML.includes('success')) {
                        container.innerHTML = '';
                    }
                }, 3000);
            }
        }
        
        function updateStatus(text) {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = text;
            
            if (text.includes('âœ…')) {
                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
            } else if (text.includes('âŒ')) {
                statusEl.innerHTML = `<i class="fas fa-times-circle"></i> ${text}`;
            } else if (text.includes('æ­£åœ¨')) {
                statusEl.innerHTML = `<i class="fas fa-sync fa-spin"></i> ${text}`;
            }
        }
        
        // ============================================
        // äº‹ä»¶ç›‘å¬å™¨
        // ============================================
        function setupEventListeners() {
            document.getElementById('submit-btn').addEventListener('click', submitMessage);
            document.getElementById('refresh-btn').addEventListener('click', loadMessages);
            document.getElementById('reconnect-btn').addEventListener('click', initConnection);
            
            // Ctrl+Enteræäº¤
            document.getElementById('message').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    submitMessage();
                }
            });
            
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
            setInterval(() => {
                if (isConnected) {
                    loadMessages();
                }
            }, 30000);
        }
        
        // ============================================
        // è¾…åŠ©å‡½æ•°
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function decodeHtml(text) {
            const txt = document.createElement('textarea');
            txt.innerHTML = text;
            return txt.value;
        }
        
        function formatTime(isoString) {
            if (!isoString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            
            return date.toLocaleDateString('zh-CN');
        }
        
        async function getClientIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'unknown';
            }
        }
    </script>
</body>
</html>
