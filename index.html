<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Azureç•™è¨€æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(90deg, #0078d4, #00bcf2); color: white; padding: 20px; text-align: center; }
        .status { display: inline-block; padding: 5px 15px; background: rgba(255,255,255,0.2); border-radius: 20px; margin-top: 10px; font-size: 14px; }
        .form-section { padding: 20px; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        textarea { min-height: 100px; resize: vertical; }
        .buttons { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #0078d4; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .messages { padding: 20px; max-height: 400px; overflow-y: auto; }
        .message { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #0078d4; }
        .azure-msg { border-left-color: #28a745; }
        .local-msg { border-left-color: #ffc107; }
        .msg-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .msg-name { font-weight: bold; color: #0078d4; }
        .msg-time { color: #666; font-size: 12px; }
        .msg-source { display: inline-block; padding: 2px 8px; background: #e9ecef; border-radius: 10px; font-size: 11px; margin-top: 5px; }
        .debug { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ Azure Tableç•™è¨€æ¿</h1>
            <div class="status" id="status">æ­£åœ¨è¿æ¥Azure...</div>
        </div>
        
        <div class="form-section">
            <input type="text" id="name" placeholder="ä½ çš„åå­—ï¼ˆå¯é€‰ï¼‰" maxlength="20">
            <textarea id="message" placeholder="è¾“å…¥ç•™è¨€å†…å®¹..." maxlength="500"></textarea>
            
            <div class="buttons">
                <button class="btn-primary" id="submit-btn">å‘å¸ƒç•™è¨€</button>
                <button class="btn-secondary" id="clear-btn">æ¸…ç©ºæœ¬åœ°</button>
                <button class="btn-success" id="test-btn">æµ‹è¯•è¿æ¥</button>
            </div>
            
            <div class="debug">
                <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong>
                <div id="debug"></div>
            </div>
        </div>
        
        <div class="messages" id="messages">
            <div style="text-align: center; color: #666; padding: 20px;">
                æ­£åœ¨åŠ è½½ç•™è¨€...
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // é…ç½® - ä½¿ç”¨ä½ å·²æœ‰çš„SASä»¤ç‰Œ
        // ============================================
        const AZURE_CONFIG = {
            accountName: 'messageboard2025',
            tableName: 'messages',
            // ä½¿ç”¨ä½ åŸæ¥çš„SASä»¤ç‰Œï¼ˆsrt=co ä¹Ÿèƒ½å·¥ä½œï¼‰
            sasToken: '?sv=2024-11-04&ss=t&srt=co&sp=rwdl&se=2026-02-12T23:59:29Z&st=2025-12-02T15:44:29Z&spr=https&sig=1KAtGlI7tHgxyzXpqMKfn9G7EHBzsszqMxhaMKTfCbw%3D'
        };
        
        const TABLE_URL = `https://${AZURE_CONFIG.accountName}.table.core.windows.net/${AZURE_CONFIG.tableName}${AZURE_CONFIG.sasToken}`;
        let isAzureConnected = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('åˆå§‹åŒ–å¼€å§‹');
            log(`è¡¨URL: ${TABLE_URL}`);
            
            setupEventListeners();
            loadMessages();
            
            // æµ‹è¯•Azureè¿æ¥
            testAzureConnection();
        });

        // æµ‹è¯•Azureè¿æ¥
        async function testAzureConnection() {
            try {
                updateStatus('æ­£åœ¨æµ‹è¯•Azureè¿æ¥...');
                
                // ç›´æ¥æµ‹è¯•è¿æ¥
                const response = await fetch(`${TABLE_URL}&$top=1`);
                
                log(`å“åº”çŠ¶æ€: ${response.status}`);
                log(`å“åº”ç±»å‹: ${response.headers.get('content-type')}`);
                
                if (response.ok) {
                    const text = await response.text();
                    
                    if (text.includes('<feed')) {
                        // XMLå“åº” - è¿æ¥æˆåŠŸä½†éœ€è¦å¤„ç†XML
                        isAzureConnected = true;
                        updateStatus('âœ… Azureè¿æ¥æˆåŠŸ (XMLæ¨¡å¼)');
                        log('æ”¶åˆ°XMLå“åº”ï¼Œè¿æ¥æˆåŠŸ');
                        
                        // å°è¯•æ·»åŠ æ•°æ®æµ‹è¯•
                        await testAddMessage();
                    } else if (text.includes('{"value"')) {
                        // JSONå“åº”
                        isAzureConnected = true;
                        updateStatus('âœ… Azureè¿æ¥æˆåŠŸ (JSONæ¨¡å¼)');
                        log('æ”¶åˆ°JSONå“åº”ï¼Œè¿æ¥æˆåŠŸ');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                isAzureConnected = false;
                updateStatus('âŒ Azureè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                log(`è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        // æµ‹è¯•æ·»åŠ ç•™è¨€
        async function testAddMessage() {
            try {
                const testMessage = {
                    PartitionKey: 'messageBoard',
                    RowKey: `test_${Date.now()}`,
                    name: 'æµ‹è¯•ç”¨æˆ·',
                    message: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•ç•™è¨€',
                    timestamp: new Date().toISOString()
                };
                
                log('å°è¯•æ·»åŠ æµ‹è¯•ç•™è¨€...');
                
                const response = await fetch(TABLE_URL, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testMessage)
                });
                
                log(`æ·»åŠ æµ‹è¯•ç•™è¨€çŠ¶æ€: ${response.status}`);
                
                if (response.ok || response.status === 204) {
                    log('âœ… æµ‹è¯•ç•™è¨€æ·»åŠ æˆåŠŸï¼');
                    updateStatus('âœ… Azureè¯»å†™æ­£å¸¸ (XMLæ¨¡å¼)');
                }
            } catch (error) {
                log(`æ·»åŠ æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½ç•™è¨€
        async function loadMessages() {
            try {
                // å…ˆæ˜¾ç¤ºæœ¬åœ°ç•™è¨€
                const localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');
                displayMessages(localMessages.map(m => ({ ...m, source: 'local' })));
                
                // å¦‚æœAzureå·²è¿æ¥ï¼Œå°è¯•åŠ è½½Azureç•™è¨€
                if (isAzureConnected) {
                    await loadAzureMessages();
                }
            } catch (error) {
                log(`åŠ è½½ç•™è¨€å¤±è´¥: ${error.message}`);
            }
        }

        // åŠ è½½Azureç•™è¨€
        async function loadAzureMessages() {
            try {
                log('æ­£åœ¨ä»AzureåŠ è½½ç•™è¨€...');
                
                // æŸ¥è¯¢Azure Table
                const queryUrl = `${TABLE_URL}&$filter=PartitionKey eq 'messageBoard'&$orderby=RowKey desc`;
                
                const response = await fetch(queryUrl);
                const text = await response.text();
                
                if (response.ok) {
                    let azureMessages = [];
                    
                    if (text.includes('<feed')) {
                        // è§£æXML
                        azureMessages = parseXmlMessages(text);
                        log(`ä»XMLè§£æå‡º ${azureMessages.length} æ¡ç•™è¨€`);
                    } else if (text.includes('{"value"')) {
                        // è§£æJSON
                        const data = JSON.parse(text);
                        azureMessages = data.value || [];
                        log(`ä»JSONè§£æå‡º ${azureMessages.length} æ¡ç•™è¨€`);
                    }
                    
                    // æ·»åŠ æ¥æºæ ‡è®°å¹¶æ˜¾ç¤º
                    const markedMessages = azureMessages.map(m => ({ ...m, source: 'azure' }));
                    displayMessages(markedMessages);
                }
            } catch (error) {
                log(`åŠ è½½Azureç•™è¨€å¤±è´¥: ${error.message}`);
            }
        }

        // è§£æXMLå“åº”
        function parseXmlMessages(xmlText) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const entries = xmlDoc.getElementsByTagName('entry');
                const messages = [];
                
                for (let entry of entries) {
                    try {
                        const properties = entry.getElementsByTagName('properties')[0];
                        if (!properties) continue;
                        
                        const message = {
                            PartitionKey: getXmlValue(properties, 'PartitionKey'),
                            RowKey: getXmlValue(properties, 'RowKey'),
                            name: getXmlValue(properties, 'name'),
                            message: getXmlValue(properties, 'message'),
                            timestamp: getXmlValue(properties, 'timestamp')
                        };
                        
                        if (message.name && message.message) {
                            messages.push(message);
                        }
                    } catch (e) {
                        // è·³è¿‡è§£æé”™è¯¯çš„æ¡ç›®
                    }
                }
                
                return messages;
            } catch (error) {
                log(`XMLè§£æå¤±è´¥: ${error.message}`);
                return [];
            }
        }

        // è·å–XMLå€¼
        function getXmlValue(parent, tagName) {
            const elements = parent.getElementsByTagName(`d:${tagName}`);
            return elements.length > 0 ? elements[0].textContent : '';
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!message) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }
            
            const newMessage = {
                name: name || 'åŒ¿åç”¨æˆ·',
                message: message,
                timestamp: new Date().toISOString(),
                device: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? 'æ‰‹æœº' : 'ç”µè„‘'
            };
            
            let savedTo = 'local';
            
            // å°è¯•ä¿å­˜åˆ°Azure
            if (isAzureConnected) {
                try {
                    const entity = {
                        PartitionKey: 'messageBoard',
                        RowKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        ...newMessage
                    };
                    
                    const response = await fetch(TABLE_URL, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(entity)
                    });
                    
                    if (response.ok || response.status === 204) {
                        savedTo = 'azure';
                        log('ç•™è¨€å·²ä¿å­˜åˆ°Azure');
                    }
                } catch (error) {
                    log(`ä¿å­˜åˆ°Azureå¤±è´¥: ${error.message}`);
                }
            }
            
            // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°
            const localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');
            localMessages.unshift({ ...newMessage, source: 'local' });
            
            if (localMessages.length > 50) {
                localMessages.length = 50;
            }
            
            localStorage.setItem('localMessages', JSON.stringify(localMessages));
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('name').value = '';
            document.getElementById('message').value = '';
            
            // é‡æ–°åŠ è½½ç•™è¨€
            loadMessages();
            
            alert(`ç•™è¨€å·²å‘å¸ƒ${savedTo === 'azure' ? 'åˆ°Azureäº‘ç«¯' : 'åˆ°æœ¬åœ°å­˜å‚¨'}ï¼`);
        }

        // æ˜¾ç¤ºç•™è¨€
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 40px;">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œæˆä¸ºç¬¬ä¸€ä¸ªç•™è¨€çš„äººå§ï¼</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="message ${msg.source === 'azure' ? 'azure-msg' : 'local-msg'}">
                    <div class="msg-header">
                        <div class="msg-name">${escapeHtml(msg.name)}</div>
                        <div class="msg-time">${formatTime(msg.timestamp)}</div>
                    </div>
                    <div>${escapeHtml(msg.message).replace(/\n/g, '<br>')}</div>
                    <div class="msg-source">
                        ${msg.source === 'azure' ? 'ğŸŒ©ï¸ Azureäº‘ç«¯' : 'ğŸ’¾ æœ¬åœ°å­˜å‚¨'}
                        ${msg.device ? ` Â· ${msg.device}` : ''}
                    </div>
                </div>
            `).join('');
        }

        // æ¸…ç©ºæœ¬åœ°ç•™è¨€
        function clearLocalMessages() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç•™è¨€å—ï¼Ÿ')) {
                localStorage.removeItem('localMessages');
                loadMessages();
                log('æœ¬åœ°ç•™è¨€å·²æ¸…ç©º');
                alert('æœ¬åœ°ç•™è¨€å·²æ¸…ç©º');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('submit-btn').addEventListener('click', submitMessage);
            document.getElementById('clear-btn').addEventListener('click', clearLocalMessages);
            document.getElementById('test-btn').addEventListener('click', testAzureConnection);
            
            // Ctrl+Enteræäº¤
            document.getElementById('message').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    submitMessage();
                }
            });
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }

        // è°ƒè¯•æ—¥å¿—
        function log(message) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debug.innerHTML += `[${time}] ${message}<br>`;
            debug.scrollTop = debug.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // è¾…åŠ©å‡½æ•°
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(isoString) {
            if (!isoString) return 'æœªçŸ¥æ—¶é—´';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            
            return date.toLocaleDateString('zh-CN');
        }
    </script>
</body>
</html>
