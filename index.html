<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Table留言板</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; }
        button { padding: 10px 20px; margin: 5px; }
        .message { background: #f5f5f5; padding: 15px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Azure Table留言板</h1>
    <div id="status">状态: 准备中...</div>
    
    <input type="text" id="name" placeholder="名字">
    <textarea id="content" placeholder="留言内容" rows="3"></textarea>
    
    <button onclick="loadMessages()">加载留言</button>
    <button onclick="submitMessage()">发布留言</button>
    
    <div id="messages"></div>

    <script>
        // ============================================
        // 配置
        // ============================================
        const CONFIG = {
            account: 'messageboard2025',
            table: 'messages',
            sas: '?sv=2024-11-04&ss=t&srt=co&sp=rwdlacu&se=2026-02-12T01:08:00Z&st=2025-12-04T16:53:00Z&spr=https&sig=O6rDzpyGQV1o9nh4OfFpZZVczqeihnFwYxGYnDd4Hp4%3D'
        };
        
        const BASE_URL = `https://${CONFIG.account}.table.core.windows.net/${CONFIG.table}`;
        const FULL_URL = `${BASE_URL}${CONFIG.sas}`;
        
        // ============================================
        // 核心函数
        // ============================================
        async function loadMessages() {
            try {
                document.getElementById('status').textContent = '状态: 加载中...';
                
                // 查询URL - 使用正确的API版本头
                const queryUrl = `${FULL_URL}&$filter=PartitionKey eq 'messages'`;
                
                console.log('查询URL:', queryUrl);
                
                const response = await fetch(queryUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json;odata=nometadata',
                        'DataServiceVersion': '3.0;NetFx',
                        'MaxDataServiceVersion': '3.0;NetFx'
                    }
                });
                
                console.log('响应状态:', response.status, response.statusText);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('响应数据:', data);
                    
                    if (data.value && data.value.length > 0) {
                        displayMessages(data.value);
                        document.getElementById('status').textContent = `状态: 已加载 ${data.value.length} 条留言`;
                    } else {
                        document.getElementById('messages').innerHTML = '<p>还没有留言</p>';
                        document.getElementById('status').textContent = '状态: 没有留言';
                    }
                } else {
                    const errorText = await response.text();
                    console.error('错误详情:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                console.error('加载失败:', error);
                document.getElementById('status').textContent = `状态: 错误 - ${error.message}`;
                
                // 尝试备用方法
                tryAlternativeLoad();
            }
        }
        
        // 备用加载方法
        async function tryAlternativeLoad() {
            try {
                console.log('尝试备用加载方法...');
                
                // 方法1: 尝试XML格式
                const response = await fetch(`${FULL_URL}&$filter=PartitionKey eq 'messages'`, {
                    headers: {
                        'Accept': 'application/atom+xml',
                        'DataServiceVersion': '1.0;NetFx'
                    }
                });
                
                if (response.ok) {
                    const xmlText = await response.text();
                    console.log('XML响应:', xmlText.substring(0, 500));
                    
                    // 解析XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    const entries = xmlDoc.getElementsByTagName('entry');
                    
                    const messages = [];
                    for (let entry of entries) {
                        const props = entry.getElementsByTagName('properties')[0];
                        if (props) {
                            const name = props.getElementsByTagName('d:name')[0]?.textContent;
                            const message = props.getElementsByTagName('d:message')[0]?.textContent;
                            const timestamp = props.getElementsByTagName('d:timestamp')[0]?.textContent;
                            
                            if (name && message) {
                                messages.push({
                                    name: name,
                                    message: message,
                                    timestamp: timestamp
                                });
                            }
                        }
                    }
                    
                    if (messages.length > 0) {
                        displayMessages(messages);
                        document.getElementById('status').textContent = `状态: 已加载 ${messages.length} 条留言(XML)`;
                    }
                }
            } catch (error) {
                console.error('备用方法也失败:', error);
            }
        }
        
        async function submitMessage() {
            const name = document.getElementById('name').value.trim();
            const content = document.getElementById('content').value.trim();
            
            if (!content) {
                alert('请输入留言内容');
                return;
            }
            
            try {
                document.getElementById('status').textContent = '状态: 保存中...';
                
                // 创建实体 - 符合Azure Table格式
                const entity = {
                    PartitionKey: 'messages',
                    RowKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    name: name || '匿名用户',
                    message: content,
                    timestamp: new Date().toISOString()
                };
                
                console.log('提交实体:', entity);
                
                // 必须包含正确的请求头
                const response = await fetch(FULL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json;odata=nometadata',
                        'DataServiceVersion': '3.0;NetFx',
                        'MaxDataServiceVersion': '3.0;NetFx',
                        'Prefer': 'return-no-content'
                    },
                    body: JSON.stringify(entity)
                });
                
                console.log('保存响应:', response.status, response.statusText);
                
                if (response.ok || response.status === 204) {
                    // 清空输入框
                    document.getElementById('name').value = '';
                    document.getElementById('content').value = '';
                    
                    // 重新加载
                    await loadMessages();
                    
                    document.getElementById('status').textContent = '状态: 留言已保存！';
                    alert('留言已成功保存到Azure Table！');
                } else {
                    const errorText = await response.text();
                    console.error('保存错误详情:', errorText);
                    
                    // 尝试备用保存方法
                    await tryAlternativeSubmit(entity, errorText);
                }
                
            } catch (error) {
                console.error('保存失败:', error);
                document.getElementById('status').textContent = `状态: 保存失败 - ${error.message}`;
                alert(`保存失败: ${error.message}`);
            }
        }
        
        // 备用保存方法
        async function tryAlternativeSubmit(entity, originalError) {
            try {
                console.log('尝试备用保存方法...');
                
                // 方法1: 尝试不同的Content-Type
                const response1 = await fetch(FULL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json;odata=nometadata',
                        'Accept': 'application/json;odata=nometadata'
                    },
                    body: JSON.stringify(entity)
                });
                
                if (response1.ok) {
                    console.log('备用方法1成功');
                    return;
                }
                
                // 方法2: 尝试直接XML格式
                const xmlBody = `
<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<entry xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://www.w3.org/2005/Atom">
  <title />
  <updated>${new Date().toISOString()}</updated>
  <author>
    <name />
  </author>
  <id />
  <content type="application/xml">
    <m:properties>
      <d:PartitionKey>${entity.PartitionKey}</d:PartitionKey>
      <d:RowKey>${entity.RowKey}</d:RowKey>
      <d:name>${entity.name}</d:name>
      <d:message>${entity.message}</d:message>
      <d:timestamp>${entity.timestamp}</d:timestamp>
    </m:properties>
  </content>
</entry>`;
                
                const response2 = await fetch(FULL_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/atom+xml',
                        'Accept': 'application/atom+xml'
                    },
                    body: xmlBody
                });
                
                console.log('XML保存响应:', response2.status);
                
            } catch (error) {
                console.error('备用保存也失败:', error);
                
                // 显示详细错误信息
                showDetailedError(entity, originalError, error.message);
            }
        }
        
        // 显示详细错误
        function showDetailedError(entity, originalError, altError) {
            const errorMsg = `
保存失败！请检查：

原始错误: ${originalError}
备用错误: ${altError}

实体数据:
${JSON.stringify(entity, null, 2)}

请求URL:
${FULL_URL}

可能的问题:
1. SAS令牌权限不足
2. 表名不正确
3. PartitionKey格式错误
4. 网络连接问题

请手动测试URL:
${FULL_URL}&$top=1
`;
            
            alert(errorMsg);
            
            // 复制实体到剪贴板方便调试
            navigator.clipboard.writeText(JSON.stringify(entity, null, 2))
                .then(() => console.log('实体已复制到剪贴板'));
        }
        
        // ============================================
        // 显示函数
        // ============================================
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<p>还没有留言</p>';
                return;
            }
            
            // 按时间排序
            messages.sort((a, b) => {
                const timeA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                const timeB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                return timeB - timeA;
            });
            
            container.innerHTML = messages.map(msg => `
                <div class="message">
                    <div><strong>${escapeHtml(msg.name)}</strong> 
                    <small>${msg.timestamp ? formatTime(msg.timestamp) : ''}</small></div>
                    <div>${escapeHtml(msg.message)}</div>
                </div>
            `).join('');
        }
        
        // ============================================
        // 辅助函数
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatTime(isoString) {
            try {
                const date = new Date(isoString);
                return date.toLocaleString('zh-CN');
            } catch {
                return isoString;
            }
        }
        
        // ============================================
        // 初始化
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Azure Table留言板启动');
            console.log('CORS已配置，尝试直接连接...');
            
            // 设置快捷键
            document.getElementById('content').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    submitMessage();
                }
            });
            
            // 初始加载
            loadMessages();
        });
    </script>
</body>
</html>
