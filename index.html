<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Azureç•™è¨€æ¿</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: #f0f2f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #0078d4; margin-bottom: 10px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
        textarea { min-height: 100px; }
        .buttons { display: flex; gap: 10px; margin: 10px 0; }
        button { flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-primary { background: #0078d4; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .messages { margin-top: 20px; }
        .message { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #0078d4; }
        .debug { background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-top: 20px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ Azureç•™è¨€æ¿</h1>
        
        <div id="status" class="status disconnected">
            æ­£åœ¨åˆå§‹åŒ–...
        </div>
        
        <div>
            <input type="text" id="name" placeholder="ä½ çš„åå­—ï¼ˆå¯é€‰ï¼‰">
            <textarea id="message" placeholder="è¾“å…¥ç•™è¨€å†…å®¹..."></textarea>
            
            <div class="buttons">
                <button class="btn-primary" id="submit-btn">å‘å¸ƒç•™è¨€</button>
                <button class="btn-secondary" id="clear-btn">æ¸…ç©ºæœ¬åœ°</button>
                <button class="btn-success" id="direct-test-btn">ç›´æ¥æµ‹è¯•è¿æ¥</button>
            </div>
        </div>
        
        <div class="debug">
            <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong>
            <div id="debug"></div>
        </div>
        
        <div class="messages" id="messages">
            æ­£åœ¨åŠ è½½ç•™è¨€...
        </div>
    </div>

    <script>
        // ============================================
        // é…ç½®
        // ============================================
        const AZURE_CONFIG = {
            accountName: 'messageboard2025',
            tableName: 'messages',
            sasToken: '?sv=2024-11-04&ss=t&srt=co&sp=rwdl&se=2026-02-12T23:59:29Z&st=2025-12-02T15:44:29Z&spr=https&sig=1KAtGlI7tHgxyzXpqMKfn9G7EHBzsszqMxhaMKTfCbw%3D'
        };
        
        // æ„å»ºURL
        const BASE_URL = `https://${AZURE_CONFIG.accountName}.table.core.windows.net/${AZURE_CONFIG.tableName}`;
        const FULL_URL = `${BASE_URL}${AZURE_CONFIG.sasToken}`;
        
        // ============================================
        // ä¸»å‡½æ•°
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log(`Azureè¡¨URL: ${BASE_URL}`);
            log(`SASä»¤ç‰Œ: ${AZURE_CONFIG.sasToken.substring(0, 50)}...`);
            
            setupEventListeners();
            loadLocalMessages();
            
            // æµ‹è¯•è¿æ¥
            testConnection();
        });

        // æµ‹è¯•è¿æ¥ - ç›´æ¥è®¿é—®URLï¼ˆä¸ä½¿ç”¨Fetch APIï¼‰
        async function testConnection() {
            try {
                updateStatus('æ­£åœ¨æµ‹è¯•Azureè¿æ¥...');
                log('æ–¹æ³•1: ç›´æ¥æµ‹è¯•è¿æ¥...');
                
                // æ–¹æ³•1: ä½¿ç”¨JSONPæ–¹å¼ï¼ˆç»•è¿‡CORSï¼‰
                await testWithJsonp();
                
            } catch (error) {
                log(`è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('âŒ Azureè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
            }
        }

        // ä½¿ç”¨JSONPæ–¹å¼æµ‹è¯•
        async function testWithJsonp() {
            return new Promise((resolve, reject) => {
                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶iframeæ¥æµ‹è¯•è¿æ¥
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = `${FULL_URL}&$top=1&callback=testCallback`;
                document.body.appendChild(iframe);
                
                // å…¨å±€å›è°ƒå‡½æ•°
                window.testCallback = function(data) {
                    log('JSONPæµ‹è¯•æˆåŠŸ');
                    document.body.removeChild(iframe);
                    resolve(true);
                };
                
                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    // å°è¯•æ–¹æ³•2: ä½¿ç”¨ä»£ç†
                    testWithProxy().then(resolve).catch(reject);
                }, 3000);
            });
        }

        // ä½¿ç”¨ä»£ç†æµ‹è¯•
        async function testWithProxy() {
            log('æ–¹æ³•2: ä½¿ç”¨CORSä»£ç†...');
            
            // å°è¯•å¤šä¸ªå…è´¹CORSä»£ç†
            const proxies = [
                'https://api.allorigins.win/raw?url=',
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest='
            ];
            
            for (let proxy of proxies) {
                try {
                    const proxyUrl = `${proxy}${encodeURIComponent(FULL_URL + '&$top=1')}`;
                    log(`å°è¯•ä»£ç†: ${proxy.substring(0, 30)}...`);
                    
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const text = await response.text();
                        log(`ä»£ç†æµ‹è¯•æˆåŠŸï¼Œå“åº”é•¿åº¦: ${text.length}`);
                        
                        if (text.includes('<feed') || text.includes('{"value"')) {
                            log('âœ… AzureæœåŠ¡æ­£å¸¸ï¼');
                            updateStatus('âœ… Azureè¿æ¥æˆåŠŸï¼ˆé€šè¿‡ä»£ç†ï¼‰');
                            
                            // ä¿å­˜ä»£ç†åœ°å€ä¾›åç»­ä½¿ç”¨
                            window.AZURE_PROXY = proxy;
                            
                            return true;
                        }
                    }
                } catch (error) {
                    log(`ä»£ç† ${proxy.substring(0, 30)}... å¤±è´¥: ${error.message}`);
                }
            }
            
            throw new Error('æ‰€æœ‰ä»£ç†éƒ½å¤±è´¥');
        }

        // ç›´æ¥æµ‹è¯•æŒ‰é’®
        async function directTest() {
            log('=== ç›´æ¥æµ‹è¯•å¼€å§‹ ===');
            
            // åœ¨æµè§ˆå™¨æ§åˆ¶å°æ˜¾ç¤ºå¯æ‰‹åŠ¨æµ‹è¯•çš„URL
            const testUrl = `${FULL_URL}&$top=1`;
            log(`æ‰‹åŠ¨æµ‹è¯•URL: ${testUrl}`);
            log('è¯·å¤åˆ¶ä¸Šé¢çš„URLåˆ°æ–°æ ‡ç­¾é¡µæµ‹è¯•');
            
            // å°è¯•ç›´æ¥æ‰“å¼€
            window.open(testUrl, '_blank');
            
            // å°è¯•ç®€å•çš„fetch
            try {
                const response = await fetch(testUrl);
                log(`ç›´æ¥fetchçŠ¶æ€: ${response.status}`);
            } catch (error) {
                log(`ç›´æ¥fetché”™è¯¯: ${error.message}`);
            }
        }

        // åŠ è½½ç•™è¨€
        async function loadMessages() {
            try {
                // å…ˆæ˜¾ç¤ºæœ¬åœ°
                const localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');
                displayMessages(localMessages.map(m => ({ ...m, source: 'local' })));
                
                // å¦‚æœä»£ç†å¯ç”¨ï¼Œå°è¯•ä»AzureåŠ è½½
                if (window.AZURE_PROXY) {
                    await loadAzureMessages();
                }
            } catch (error) {
                log(`åŠ è½½ç•™è¨€é”™è¯¯: ${error.message}`);
            }
        }

        // åŠ è½½Azureç•™è¨€
        async function loadAzureMessages() {
            try {
                const proxy = window.AZURE_PROXY;
                const queryUrl = `${proxy}${encodeURIComponent(FULL_URL + '&$filter=PartitionKey eq \'messageBoard\'&$orderby=RowKey desc')}`;
                
                const response = await fetch(queryUrl);
                const text = await response.text();
                
                if (response.ok) {
                    let azureMessages = [];
                    
                    if (text.includes('<feed')) {
                        // ç®€å•è§£æXML
                        const entries = text.split('<entry>');
                        for (let entry of entries) {
                            if (entry.includes('name') && entry.includes('message')) {
                                const nameMatch = entry.match(/<d:name[^>]*>([^<]*)<\/d:name>/);
                                const messageMatch = entry.match(/<d:message[^>]*>([^<]*)<\/d:message>/);
                                const timeMatch = entry.match(/<d:timestamp[^>]*>([^<]*)<\/d:timestamp>/);
                                
                                if (nameMatch && messageMatch) {
                                    azureMessages.push({
                                        name: nameMatch[1],
                                        message: messageMatch[1],
                                        timestamp: timeMatch ? timeMatch[1] : new Date().toISOString(),
                                        source: 'azure'
                                    });
                                }
                            }
                        }
                    }
                    
                    if (azureMessages.length > 0) {
                        displayMessages(azureMessages);
                        log(`ä»AzureåŠ è½½äº† ${azureMessages.length} æ¡ç•™è¨€`);
                    }
                }
            } catch (error) {
                log(`åŠ è½½Azureç•™è¨€é”™è¯¯: ${error.message}`);
            }
        }

        // æäº¤ç•™è¨€
        async function submitMessage() {
            const name = document.getElementById('name').value.trim();
            const message = document.getElementById('message').value.trim();
            
            if (!message) {
                alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                return;
            }
            
            const newMessage = {
                name: name || 'åŒ¿åç”¨æˆ·',
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°æœ¬åœ°
            const localMessages = JSON.parse(localStorage.getItem('localMessages') || '[]');
            localMessages.unshift({ ...newMessage, source: 'local' });
            
            if (localMessages.length > 50) {
                localMessages.length = 50;
            }
            
            localStorage.setItem('localMessages', JSON.stringify(localMessages));
            
            // å°è¯•ä¿å­˜åˆ°Azureï¼ˆé€šè¿‡ä»£ç†ï¼‰
            if (window.AZURE_PROXY) {
                try {
                    const entity = {
                        PartitionKey: 'messageBoard',
                        RowKey: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        ...newMessage
                    };
                    
                    const proxy = window.AZURE_PROXY;
                    const response = await fetch(`${proxy}${encodeURIComponent(FULL_URL)}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(entity)
                    });
                    
                    if (response.ok) {
                        log('ç•™è¨€å·²åŒæ—¶ä¿å­˜åˆ°Azure');
                    }
                } catch (error) {
                    log(`ä¿å­˜åˆ°Azureå¤±è´¥: ${error.message}`);
                }
            }
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('name').value = '';
            document.getElementById('message').value = '';
            
            // é‡æ–°åŠ è½½
            loadMessages();
            
            alert('ç•™è¨€å·²å‘å¸ƒï¼');
        }

        // æ˜¾ç¤ºç•™è¨€
        function displayMessages(messages) {
            const container = document.getElementById('messages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">è¿˜æ²¡æœ‰ç•™è¨€</div>';
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="message">
                    <div style="font-weight: bold; color: #0078d4;">
                        ${escapeHtml(msg.name)} 
                        <span style="float: right; font-size: 12px; color: #666;">
                            ${formatTime(msg.timestamp)}
                        </span>
                    </div>
                    <div style="margin: 5px 0;">${escapeHtml(msg.message).replace(/\n/g, '<br>')}</div>
                    <div style="font-size: 12px; color: #666;">
                        ${msg.source === 'azure' ? 'ğŸŒ©ï¸ Azureäº‘ç«¯' : 'ğŸ’¾ æœ¬åœ°å­˜å‚¨'}
                    </div>
                </div>
            `).join('');
        }

        // æ¸…ç©ºæœ¬åœ°ç•™è¨€
        function clearLocalMessages() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç•™è¨€å—ï¼Ÿ')) {
                localStorage.removeItem('localMessages');
                loadMessages();
                log('æœ¬åœ°ç•™è¨€å·²æ¸…ç©º');
                alert('æœ¬åœ°ç•™è¨€å·²æ¸…ç©º');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('submit-btn').addEventListener('click', submitMessage);
            document.getElementById('clear-btn').addEventListener('click', clearLocalMessages);
            document.getElementById('direct-test-btn').addEventListener('click', directTest);
            
            // Enteræäº¤
            document.getElementById('message').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    e.preventDefault();
                    submitMessage();
                }
            });
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            
            if (text.includes('âœ…')) {
                statusEl.className = 'status connected';
            } else if (text.includes('âŒ')) {
                statusEl.className = 'status disconnected';
            } else {
                statusEl.className = 'status';
            }
        }

        // è°ƒè¯•æ—¥å¿—
        function log(message) {
            const debug = document.getElementById('debug');
            const time = new Date().toLocaleTimeString();
            debug.innerHTML += `[${time}] ${message}<br>`;
            debug.scrollTop = debug.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // è¾…åŠ©å‡½æ•°
        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            
            return date.toLocaleDateString('zh-CN');
        }
        
        // åŠ è½½æœ¬åœ°ç•™è¨€
        function loadLocalMessages() {
            const messages = JSON.parse(localStorage.getItem('localMessages') || '[]');
            displayMessages(messages.map(m => ({ ...m, source: 'local' })));
            log(`ä»æœ¬åœ°åŠ è½½äº† ${messages.length} æ¡ç•™è¨€`);
        }
    </script>
</body>
</html>
